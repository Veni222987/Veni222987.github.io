---
title: RPC框架的原理与设计
date: 2023-08-08 10:03:56
tags:
- 后端
---

# <center> RPC框架的原理与设计

RPC（Remote Procedure Call）是一种通信协议，用于实现跨网络的远程方法调用。RPC框架提供了一套封装好的API和协议，使得开发者可以方便地进行远程方法调用。<!--more-->



## 基本概念

### 远程函数调用

RPC需要解决的问题：函数映射，数据转换字节流，网络传输。

### RPC概念模型

1984年Nelson发表论文提出RPC过程由五个模型组成：`User, User-Stub, RPC-Runtime, Server-Stub, Server`。

### 一次RPC的完整过程。

- IDL文件：接口定义文件

- 生成代码：通过编译器把IDL转换成本地链接库

- 编解码：序列化与反序列化

- 通信协议：

- 网络传输：基于成熟的UDP或TCP传输

### RPC的好处

- 单一职责，有利于分工协作和运维开发
- 可扩展性强，资源使用率更优
- 故障隔离，服务的整体可靠性更高

### RPC带来的问题

服务宕机、网络异常、请求量突增。



## 分层设计

RPC框架主要分为三层实现：编解码层，协议层，网络通信层。

### 编解码层

#### 生成代码

![image-20230808102918445](https://vblog-1315512378.cos.ap-guangzhou.myqcloud.com/imgs/vblog/202308081029262.webp)

#### 数据格式

- 语言特定格式：编程语言内建的将对象编码为字节序列的支持，如Java有java.io.Serializable。
- 文本格式：JSON，XML，CSV，缺点是无法格式化，比如指定小数位数。
- 二进制编码：BinaryProtocol, Protobuf等

#### 二进制编码

TLV编码：Tag, Length, Value。

#### 选型

需要考虑三个角度：

- 兼容性：增加新字段而不影响老服务

- 通用性：支持跨平台，跨语言

- 性能：从空间和实践两个维度考虑，也就是编码后的数据大小和编码耗费时长。



### 协议层

#### 概念

协议层规定了传输的内容是如何组织的，传输的消息如何分割和读取。常见的有以下两种协议：

- 特殊结束符：使用特殊字符作为每个协议单元结束的标识。比如`|message|\r\n|message|\r\n|`。

- 变长协议：以定长加不定长的部分组成，其中定长的部分需要描述不定长的内容长度。比如`|length|message|length|message|`。

#### 协议工作过程

- 协议构造
- 协议解析：

### 网络通信层

#### Sockets API



#### 网络库

- 提供简单易用的API：
- 功能：协议支持，优雅退出
- 性能：应用层buffer减少copy



## RPC关键指标

- 稳定性
- 易用性
- 扩展性
- 观测性
- 高性能

## RPC实例

### 整体架构——Kitex架构

### 自研网络库——Netpoll

### 性能优化
